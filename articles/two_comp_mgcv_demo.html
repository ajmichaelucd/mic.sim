<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="mic.sim">
<title>two_comp_mgcv_demo • mic.sim</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="two_comp_mgcv_demo">
<meta property="og:description" content="mic.sim">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">mic.sim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/two_comp_mgcv_demo.html">two_comp_mgcv_demo</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ajmichaelucd/mic.sim/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>two_comp_mgcv_demo</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ajmichaelucd/mic.sim/blob/HEAD/vignettes/two_comp_mgcv_demo.Rmd" class="external-link"><code>vignettes/two_comp_mgcv_demo.Rmd</code></a></small>
      <div class="d-none name"><code>two_comp_mgcv_demo.Rmd</code></div>
    </div>

    
    
<pre><code><span><span class="co">#&gt; Loading required package: nlme</span></span>
<span><span class="co">#&gt; This is mgcv 1.9-0. For overview type 'help("mgcv-package")'.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:nlme':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     collapse</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span></code></pre>
<div class="section level2">
<h2 id="the-data">The data<a class="anchor" aria-label="anchor" href="#the-data"></a>
</h2>
<p>Our data degenerating mechanism is a Gaussian mixture with two
components, with nonlinear trends in the component means, fixed
component standard deviations, and nonlinear trends trends in the
component weights. The data is interval censored within the range of
tested concentrations between tested concentrations (integer values),
right censored above the upper bound (here 5), and left censored below
the lower bound (here -3)</p>
<p><img src="two_comp_mgcv_demo_files/figure-html/unnamed-chunk-2-1.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="model-fit">Model Fit<a class="anchor" aria-label="anchor" href="#model-fit"></a>
</h2>
<p>Our model uses an EM algorithm to estimate trends in mu for each
component and trends in the weights of components. We use the mgcv
package’s gam function to fit these, using the cnorm family for the mu
models and a binomial model with a logit link for the pi model. Then we
compute weights for each observation that we plug into the next model
fit in the next iteration. As a note, we do split the data by component
before fitting the mu models because of some issues we’d run into in
previous attempts to fit a stratified model that also contains splines
while still using the survival package for the mu models.<br>
We’ll look more at the EM algorithm later, first I’d like to demonstrate
the current issue we are encountering<br>
Here we try to fit the full model and run into the primary issue that
we’ve been having: the log likelihood decreases between steps of the EM
algorithm instead of increasing monotonically. In some other instances
(though not this one), we also get an error with some other data sets
that reads:<br>
Fitting terminated with step failure - check results carefully Error in
gam.fit3(x = X, y = y, sp = L %*% lsp + lsp0, Eb = Eb, UrS = UrS</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span> <span class="op">=</span> <span class="fu"><a href="../reference/EM_algorithm_mgcv.html">EM_algorithm_mgcv</a></span><span class="op">(</span><span class="va">example_data</span>,</span>
<span>                  mu_formula <span class="op">=</span> <span class="va">yi</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>,</span>
<span>                  pi_formula <span class="op">=</span> <span class="va">c</span> <span class="op">==</span> <span class="st">"2"</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>,</span>
<span>                  max_it <span class="op">=</span> <span class="fl">25</span>,</span>
<span>                  ncomp <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                  tol_ll <span class="op">=</span> <span class="fl">1e-6</span>,</span>
<span>                  browse_at_end <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  browse_each_step <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  plot_visuals <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  prior_step_plot <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  pause_on_likelihood_drop <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                  pi_link <span class="op">=</span> <span class="st">"logit"</span>,</span>
<span>                  verbose <span class="op">=</span> <span class="fl">2</span>,</span>
<span>                  model_coefficient_tolerance <span class="op">=</span> <span class="fl">0.00001</span>,</span>
<span>                  initial_weighting <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="co">#&gt; starting iteration number 1</span></span>
<span><span class="co">#&gt; starting iteration number 2</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 3</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 4</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 5</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 6</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 7</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 8</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 9</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 10</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 11</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 12</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 13</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 14</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 15</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 16</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 17</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 18</span></span>
<span><span class="co">#&gt; starting iteration number 19</span></span>
<span><span class="co">#&gt; starting iteration number 20</span></span>
<span><span class="co">#&gt; starting iteration number 21</span></span>
<span><span class="co">#&gt; starting iteration number 22</span></span>
<span><span class="co">#&gt; starting iteration number 23</span></span>
<span><span class="co">#&gt; Warning in EM_algorithm_mgcv(example_data, mu_formula = yi ~ s(t), pi_formula =</span></span>
<span><span class="co">#&gt; c == : Log Likelihood decreased</span></span>
<span><span class="co">#&gt; starting iteration number 24</span></span>
<span><span class="co">#&gt; starting iteration number 25</span></span>
<span><span class="co">#&gt; Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L,</span></span>
<span><span class="co">#&gt; : Fitting terminated with step failure - check results carefully</span></span>
<span></span>
<span><span class="co">#&gt; Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L,</span></span>
<span><span class="co">#&gt; : Log Likelihood decreased</span></span></code></pre></div>
<p>And we plot the log likelihood of each step, the EM algorithm should
be monotonically increasing but we see drops early, then also some
later.</p>
<p><img src="two_comp_mgcv_demo_files/figure-html/unnamed-chunk-4-1.png" width="768"></p>
<p>So now I thought I’d remove the splines and see if the rest of the
algorithm is working as intended. First, I’ll try to fit it all without
any nonlinear trends in mu or pi</p>
</div>
<div class="section level2">
<h2 id="no-nonlinear-trends">No Nonlinear Trends<a class="anchor" aria-label="anchor" href="#no-nonlinear-trends"></a>
</h2>
<p>I used survreg with a gaussian distribution and no splines for mu
models and a glm for the logistic regression. Previously, using survreg
with pspline for nonlinear trends in our EM algorithm also resulted in
log likelihood decreases which is why we tried switching to mgcv</p>
<p><img src="two_comp_mgcv_demo_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
<p>So the log likelihood increases monotonically here, that’s a good
sign</p>
<p><img src="two_comp_mgcv_demo_files/figure-html/unnamed-chunk-6-1.png" width="768"></p>
<p>And the plot looks good<br>
Now let’s try to add them back in, starting with mu</p>
</div>
<div class="section level2">
<h2 id="nonlinear-trend-in-mu-only">Nonlinear trend in mu only<a class="anchor" aria-label="anchor" href="#nonlinear-trend-in-mu-only"></a>
</h2>
<pre><code><span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span><span class="co">#&gt; [1] 5</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span><span class="co">#&gt; [1] 7</span></span>
<span><span class="co">#&gt; [1] 8</span></span>
<span><span class="co">#&gt; [1] 9</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="co">#&gt; [1] 11</span></span>
<span><span class="co">#&gt; [1] 12</span></span>
<span><span class="co">#&gt; [1] 13</span></span>
<span><span class="co">#&gt; [1] 14</span></span>
<span><span class="co">#&gt; [1] 15</span></span>
<span><span class="co">#&gt; [1] 16</span></span>
<span><span class="co">#&gt; [1] 17</span></span>
<span><span class="co">#&gt; [1] 18</span></span>
<span><span class="co">#&gt; [1] 19</span></span>
<span><span class="co">#&gt; [1] 20</span></span>
<span><span class="co">#&gt; [1] 21</span></span>
<span><span class="co">#&gt; [1] 22</span></span>
<span><span class="co">#&gt; [1] 23</span></span>
<span><span class="co">#&gt; Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L,</span></span>
<span><span class="co">#&gt; : Fitting terminated with step failure - check results carefully</span></span>
<span><span class="co">#&gt; [1] 24</span></span>
<span><span class="co">#&gt; Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L,</span></span>
<span><span class="co">#&gt; : Fitting terminated with step failure - check results carefully</span></span>
<span><span class="co">#&gt; [1] 25</span></span>
<span><span class="co">#&gt; Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L,</span></span>
<span><span class="co">#&gt; : Fitting terminated with step failure - check results carefully</span></span></code></pre>
<p><img src="two_comp_mgcv_demo_files/figure-html/unnamed-chunk-7-1.png" width="768"></p>
<p>Not what we’d like, now we got warnings reading: Fitting terminated
with step failure - check results carefully And we definitely have
decreases in likelihood through the 25 iterations</p>
<p><img src="two_comp_mgcv_demo_files/figure-html/unnamed-chunk-8-1.png" width="768"></p>
<p>And the plot doesn’t look too good either, Component 2 should be the
upper component and here it is lower than component 1</p>
<p>Next we’ll do nonlinear trends in pi only</p>
<p><img src="two_comp_mgcv_demo_files/figure-html/unnamed-chunk-9-1.png" width="768"></p>
<p>No decreases in likelihood, that’s a good sign</p>
<p><img src="two_comp_mgcv_demo_files/figure-html/unnamed-chunk-10-1.png" width="768"></p>
<p>And the plot looks good too. So our issue with the likelihood
decreases likely lies with the mu models</p>
</div>
<div class="section level2">
<h2 id="how-the-em-algorithm-works">How the EM algorithm works<a class="anchor" aria-label="anchor" href="#how-the-em-algorithm-works"></a>
</h2>
<p>Initial Weighting/First E step weights observations by their
proximity to the upper and lower boundaries</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">initial_data</span> <span class="op">=</span> <span class="va">example_data</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span>obs_id <span class="op">=</span> <span class="fu">row_number</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="va">obs_id</span>, <span class="fu">everything</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="../reference/initial_weighting_fixed_regression_at_boundaries.html">initial_weighting_fixed_regression_at_boundaries</a></span><span class="op">(</span><span class="va">.</span>, <span class="fl">2</span>, <span class="fl">0.2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_initial_weighting_regression.html">plot_initial_weighting_regression</a></span><span class="op">(</span><span class="va">initial_data</span><span class="op">)</span></span></code></pre></div>
<p><img src="two_comp_mgcv_demo_files/figure-html/unnamed-chunk-11-1.png" width="768"></p>
<p>Then we run a for loop for the EM algorithm, starting with the first
M step, where we separate our data by component and fit weighted GAMs
with the cnorm family for the component means, E(Y|t,c) and a binomial
GAM with a logit link for the component weights, P(C=c|t). Then in the
next E step we use these models to calculate P(C=c|y,t), which we use as
the observation weights in the next M step, and repeat.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">max_it</span> <span class="op">=</span> <span class="fl">25</span></span>
<span><span class="va">likelihood_documentation</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>data <span class="op">=</span> <span class="cn">NA</span>, nrow <span class="op">=</span> <span class="va">max_it</span>, ncol <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">likelihood_documentation</span> <span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="va">max_it</span></span>
<span><span class="va">possible_data</span> <span class="op">=</span> <span class="va">initial_data</span> <span class="op">%&gt;%</span> <span class="fu">mutate</span><span class="op">(</span></span>
<span>      left_bound_mgcv <span class="op">=</span></span>
<span>        <span class="fu">case_when</span><span class="op">(</span></span>
<span>          <span class="va">left_bound</span> <span class="op">==</span> <span class="op">-</span><span class="cn">Inf</span> <span class="op">~</span> <span class="va">right_bound</span>,</span>
<span>          <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">left_bound</span></span>
<span>        <span class="op">)</span>,</span>
<span>      right_bound_mgcv <span class="op">=</span></span>
<span>        <span class="fu">case_when</span><span class="op">(</span></span>
<span>          <span class="va">left_bound</span> <span class="op">==</span> <span class="op">-</span><span class="cn">Inf</span> <span class="op">~</span> <span class="op">-</span><span class="cn">Inf</span>,</span>
<span>          <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">right_bound</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="va">models</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">max_it</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">mu_models_old</span> <span class="op">=</span> <span class="va">mu_models_new</span></span>
<span>        <span class="va">pi_model_old</span> <span class="op">=</span> <span class="va">pi_model_new</span></span>
<span>        <span class="va">log_likelihood_old</span> <span class="op">=</span> <span class="va">log_likelihood_new</span></span>
<span>        <span class="va">possible_data_old</span> <span class="op">=</span> <span class="va">possible_data</span></span>
<span>    <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">mu_model</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">possible_data</span>, <span class="va">pred_comp</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">df</span> <span class="op">=</span> <span class="va">possible_data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">c</span> <span class="op">==</span> <span class="va">pred_comp</span> <span class="op">&amp;</span> <span class="va">`P(C=c|y,t)`</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">yi</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">left_bound_mgcv</span>, <span class="va">df</span><span class="op">$</span><span class="va">right_bound_mgcv</span><span class="op">)</span></span>
<span>    <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">yi</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>, family<span class="op">=</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/cnorm.html" class="external-link">cnorm</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span>, weights <span class="op">=</span> <span class="va">`P(C=c|y,t)`</span>, data<span class="op">=</span><span class="va">df</span>, method <span class="op">=</span> <span class="st">"ML"</span><span class="op">)</span>      <span class="op">%&gt;%</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">mu_models_new</span> <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="op">~</span><span class="fu">mu_model</span><span class="op">(</span>possible_data <span class="op">=</span> <span class="va">possible_data</span>, pred_comp <span class="op">=</span> <span class="va">.x</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">pi_model_new</span> <span class="op">=</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">c</span> <span class="op">==</span> <span class="st">"2"</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">t</span><span class="op">)</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">binomial</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"logit"</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">possible_data</span>, weights <span class="op">=</span> <span class="va">`P(C=c|y,t)`</span>, method <span class="op">=</span> <span class="st">"ML"</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">possible_data</span> <span class="op">%&lt;&gt;%</span></span>
<span>        <span class="fu">mutate</span><span class="op">(</span></span>
<span>          `E[Y|t,c]` <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span><span class="va">c</span> <span class="op">==</span> <span class="st">"1"</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mu_models_new</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, newdata <span class="op">=</span> <span class="va">possible_data</span><span class="op">)</span>,</span>
<span>                                 <span class="va">c</span> <span class="op">==</span> <span class="st">"2"</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mu_models_new</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, newdata <span class="op">=</span> <span class="va">possible_data</span><span class="op">)</span>,</span>
<span>                                 <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NaN</span><span class="op">)</span>,</span>
<span>          `sd[Y|t,c]` <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span><span class="va">c</span> <span class="op">==</span> <span class="st">"1"</span> <span class="op">~</span> <span class="va">mu_models_new</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">family</span><span class="op">$</span><span class="fu">getTheta</span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                                  <span class="va">c</span> <span class="op">==</span> <span class="st">"2"</span> <span class="op">~</span> <span class="va">mu_models_new</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">family</span><span class="op">$</span><span class="fu">getTheta</span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span>, <span class="co">#1,</span></span>
<span>                                  <span class="cn">TRUE</span> <span class="op">~</span> <span class="cn">NaN</span><span class="op">)</span>,</span>
<span>          `P(Y|t,c)` <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>            <span class="va">left_bound</span> <span class="op">==</span> <span class="va">right_bound</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">dnorm</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">left_bound</span>, mean <span class="op">=</span> <span class="va">`E[Y|t,c]`</span>, sd <span class="op">=</span>  <span class="va">`sd[Y|t,c]`</span><span class="op">)</span>,</span>
<span>            <span class="va">left_bound</span> <span class="op">&lt;=</span> <span class="va">`E[Y|t,c]`</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">right_bound</span>, mean <span class="op">=</span> <span class="va">`E[Y|t,c]`</span>, sd <span class="op">=</span>  <span class="va">`sd[Y|t,c]`</span><span class="op">)</span> <span class="op">-</span></span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">left_bound</span>, mean <span class="op">=</span> <span class="va">`E[Y|t,c]`</span>, sd <span class="op">=</span>  <span class="va">`sd[Y|t,c]`</span><span class="op">)</span>,</span>
<span>            <span class="cn">TRUE</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">left_bound</span>, mean <span class="op">=</span> <span class="va">`E[Y|t,c]`</span>, sd <span class="op">=</span>  <span class="va">`sd[Y|t,c]`</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">-</span></span>
<span>              <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">pnorm</a></span><span class="op">(</span><span class="va">right_bound</span>, mean <span class="op">=</span> <span class="va">`E[Y|t,c]`</span>, sd <span class="op">=</span>  <span class="va">`sd[Y|t,c]`</span>, lower.tail <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          `P(C=c|t)` <span class="op">=</span> <span class="fu">case_when</span><span class="op">(</span></span>
<span>            <span class="va">c</span> <span class="op">==</span> <span class="st">"2"</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">pi_model_new</span>, newdata <span class="op">=</span> <span class="fu">tibble</span><span class="op">(</span>t <span class="op">=</span> <span class="va">t</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span>,</span>
<span>            <span class="va">c</span> <span class="op">==</span> <span class="st">"1"</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">pi_model_new</span>, newdata <span class="op">=</span> <span class="fu">tibble</span><span class="op">(</span>t <span class="op">=</span> <span class="va">t</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>          `P(c,y|t)` <span class="op">=</span> <span class="va">`P(C=c|t)`</span> <span class="op">*</span> <span class="va">`P(Y|t,c)`</span></span>
<span>        <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">mutate</span><span class="op">(</span>.by <span class="op">=</span> <span class="va">obs_id</span>,</span>
<span>               `P(Y=y|t)` <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">`P(c,y|t)`</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>        <span class="fu">mutate</span><span class="op">(</span></span>
<span>          `P(C=c|y,t)` <span class="op">=</span> <span class="va">`P(c,y|t)`</span> <span class="op">/</span> <span class="va">`P(Y=y|t)`</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">log_likelihood_obs</span> <span class="op">=</span> <span class="va">possible_data</span> <span class="op">%&gt;%</span></span>
<span>          <span class="fu">summarise</span><span class="op">(</span>.by <span class="op">=</span> <span class="va">obs_id</span>, likelihood_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">`P(c,y|t)`</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>          <span class="fu">mutate</span><span class="op">(</span>log_likelihood_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">likelihood_i</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">log_likelihood_new</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">log_likelihood_obs</span><span class="op">$</span><span class="va">log_likelihood_i</span><span class="op">)</span></span>
<span>  <span class="va">likelihood_documentation</span><span class="op">[</span><span class="va">i</span>, <span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="va">log_likelihood_new</span></span>
<span>  </span>
<span>  <span class="va">models</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mu <span class="op">=</span> <span class="va">mu_models_new</span>, pi <span class="op">=</span> <span class="va">pi_model_new</span>, data <span class="op">=</span> <span class="va">possible_data</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="co">#&gt; [1] 3</span></span>
<span><span class="co">#&gt; [1] 4</span></span>
<span><span class="co">#&gt; [1] 5</span></span>
<span><span class="co">#&gt; [1] 6</span></span>
<span><span class="co">#&gt; [1] 7</span></span>
<span><span class="co">#&gt; [1] 8</span></span>
<span><span class="co">#&gt; [1] 9</span></span>
<span><span class="co">#&gt; [1] 10</span></span>
<span><span class="co">#&gt; [1] 11</span></span>
<span><span class="co">#&gt; [1] 12</span></span>
<span><span class="co">#&gt; [1] 13</span></span>
<span><span class="co">#&gt; [1] 14</span></span>
<span><span class="co">#&gt; [1] 15</span></span>
<span><span class="co">#&gt; [1] 16</span></span>
<span><span class="co">#&gt; [1] 17</span></span>
<span><span class="co">#&gt; [1] 18</span></span>
<span><span class="co">#&gt; [1] 19</span></span>
<span><span class="co">#&gt; [1] 20</span></span>
<span><span class="co">#&gt; [1] 21</span></span>
<span><span class="co">#&gt; [1] 22</span></span>
<span><span class="co">#&gt; [1] 23</span></span>
<span><span class="co">#&gt; [1] 24</span></span>
<span><span class="co">#&gt; [1] 25</span></span>
<span><span class="co">#&gt; Warning in newton(lsp = lsp, X = G$X, y = G$y, Eb = G$Eb, UrS = G$UrS, L = G$L,</span></span>
<span><span class="co">#&gt; : Fitting terminated with step failure - check results carefully</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_likelihood.html">plot_likelihood</a></span><span class="op">(</span><span class="va">likelihood_documentation</span>, format <span class="op">=</span> <span class="st">"matrix"</span><span class="op">)</span></span></code></pre></div>
<p><img src="two_comp_mgcv_demo_files/figure-html/unnamed-chunk-12-1.png" width="768"></p>
<p><img src="two_comp_mgcv_demo_files/figure-html/unnamed-chunk-13-1.png" width="768"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by The package maintainer.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
